<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>Babel快速上手使用指南</title><meta name="description" content="小郭的个人博客，记录学习生活"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="在刚开始使用 babel 的时候，相信很多同学应该和我一样，对于 babel 的使用配置一知半解，babel 相关的包@babel&amp;#x2F;core，@babel&amp;#x2F;cli，babel-loader，@babel&amp;#x2F;polyfill，@babel&amp;#x2F;plugin-transform-runtime，@babel&amp;#x2F;runtime 何时引入又有什么作用和区别会感到疑惑。这篇文章的目的就是帮助还没使用或刚刚使用 babel 的同学快速了解这些内容，游刃有余的使用 babel 这个强大的工具。对于想要更深入了解 babel 的推荐官方的文档：中文，英文。
说明：本文使用 babel 版本为 7，webpack 版本为 4，不同版本安装和配置存在差异。
什么是 babelbabel.."><meta name="generator" content="Hexo 6.2.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Haojen's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Babel快速上手使用指南</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-babel"><span class="toc-text">什么是 babel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-text">配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Plugins-%E5%92%8C-Presets"><span class="toc-text">Plugins 和 Presets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#preset-env"><span class="toc-text">preset-env</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#plugin-transform-runtime-%E5%92%8C-runtime"><span class="toc-text">plugin-transform-runtime 和 runtime</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babel-polyfill"><span class="toc-text">babel-polyfill</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#plugin-transform-runtime-%E5%92%8C-babel-polyfill-%E7%9A%84%E8%AE%A8%E8%AE%BA"><span class="toc-text">plugin-transform-runtime 和 babel-polyfill 的讨论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E6%80%BB%E7%BB%93"><span class="toc-text">最后总结</span></a></li></ol></div><div class="column is-9"><header class="my-4"></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Babel快速上手使用指南</h1><time class="has-text-grey" datetime="2022-06-03T11:40:50.656Z">2022-06-03</time><article class="mt-2 post-content"><p>在刚开始使用 babel 的时候，相信很多同学应该和我一样，对于 babel 的使用配置一知半解，babel 相关的包@babel&#x2F;core，@babel&#x2F;cli，babel-loader，@babel&#x2F;polyfill，@babel&#x2F;plugin-transform-runtime，@babel&#x2F;runtime 何时引入又有什么作用和区别会感到疑惑。这篇文章的目的就是帮助还没使用或刚刚使用 babel 的同学快速了解这些内容，游刃有余的使用 babel 这个强大的工具。<br>对于想要更深入了解 babel 的推荐官方的文档：<a target="_blank" rel="noopener" href="https://www.babeljs.cn/">中文</a>，<a target="_blank" rel="noopener" href="https://babeljs.io/">英文</a>。</p>
<p><strong>说明：本文使用 babel 版本为 7，webpack 版本为 4，不同版本安装和配置存在差异。</strong></p>
<h2 id="什么是-babel"><a href="#什么是-babel" class="headerlink" title="什么是 babel"></a>什么是 babel</h2><p>babel 是一个 Javascript 编译器，是目前前端开发最常用的工具之一，主要用于将 ECMAScript 2015+ 版本的代码转换为向后兼容的 JavaScript 语法，以便能够运行在当前和旧版本的浏览器或其他环境。比如在代码中使用了 ES6 的箭头函数，这种写法在 IE 里面是会报错的，为了让代码能在 IE 中运行，就需要将代码编译成 IE 支持的写法，这就是 babel 的工作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">fn</span> = (<span class="params">arg</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(arg);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//babel转换后</span></span><br><span class="line"></span><br><span class="line">(<span class="string">&quot;use strict&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn = <span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(arg);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><ol>
<li>命令行工具中使用</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 在项目中执行</span><br><span class="line">npm i @babel/core @babel-cli -D</span><br></pre></td></tr></table></figure>

<p>安装之后，就可以在 package.json 的 scripts 中执行 babel 的脚本命令了。当然也可以全局安装，这样可以在命令行工具中直接使用 babel 命令，但是并不推荐。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;babel src -d dist&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>接着命令行执行 npm run build，babel 就会将 src 文件夹中的文件编译好，并输出到 dist 文件夹。</p>
<ol start="2">
<li>webpack 中使用</li>
</ol>
<p>比起直接用命令行命令，现在我们的项目通常都使用了打包工具，如果可以将 babel 和打包工具结合，在打包时自动调用 babel 编译代码那就更加方便。这里以 webpack 为例，在 webpack 中如果想使用 babel 的编译功能，需要安装 babel-loader。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @babel/core babel-loader -D</span><br></pre></td></tr></table></figure>

<p>然后在 webpack 的配置文件中，配置用 babel-loader 来加载处理 js 文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/app.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;dist&quot;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;bundle.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [&#123; <span class="attr">test</span>: <span class="regexp">/\.js$/</span>, <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>, <span class="attr">loader</span>: <span class="string">&quot;babel-loader&quot;</span> &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>更多使用方式</li>
</ol>
<p>babel 还提供了很多其他使用方式，比如直接配合编辑器使用，或者别的打包工具比如 Gulp，Grunt 之类的，更多方法可以去<a target="_blank" rel="noopener" href="https://www.babeljs.cn/setup#webpack">官网</a>查到。</p>
<p><strong>说明：@babel&#x2F;core 是 babel7 版本的基础包，是必须引入的。</strong></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>使用方法很简单，但只是这样还不够，现在执行 babel 编译，会发现编译是成功的，但是编译后的内容和编译前没有任何区别，那是因为我们没有告诉 babel 要怎么去编译，编译哪些内容，我们需要一个配置文件来告诉 babel 如何工作。<br>配置文件的方式有以下几种：</p>
<ol>
<li>在 package.json 中设置 babel 字段。</li>
<li>.babelrc 文件或.babelrc.js</li>
<li>babel.config.js 文件</li>
</ol>
<p>第 1 种方式不用创建文件，package.json 加入 babel 的配置信息就行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//package.json</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;name&quot;</span>:<span class="string">&quot;babel-test&quot;</span>,</span><br><span class="line">   <span class="string">&quot;version&quot;</span>:<span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">   <span class="string">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">       <span class="string">&quot;@babel/core&quot;</span>:<span class="string">&quot;^7.4.5&quot;</span>,</span><br><span class="line">       <span class="string">&quot;@babel/cli&quot;</span>:<span class="string">&quot;^7.4.4&quot;</span>,</span><br><span class="line">       <span class="string">&quot;@babel/preset-env&quot;</span>:<span class="string">&quot;^7.4.5&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="string">&quot;babel&quot;</span>: &#123;</span><br><span class="line">       <span class="string">&quot;presets&quot;</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二种.babelrc 和.babelrc.js 是同一种配置方式，只是文件格式不同，一个是 json 文件，一个是 js 文件。</p>
<p>.babelrc</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;presets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;@babel/preset-env&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>.babelrc.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//webpack的配置文件也是这种写法</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这两个配置文件是针对文件夹的，即该配置文件所在的文件夹包括子文件夹都会应用此配置文件的设置，而且下层配置文件会覆盖上层配置文件，通过此种方式可以给不同的目录设置不同的规则。<br>而第 3 种 babel.config.js 虽然写法和.babelrc.js 一样，但是 babel.config.js 是针对整个项目，一个项目只有一个放在项目根目录。</p>
<p><strong>注意 1：.babelrc 文件放置在项目根目录和 babel.config.js 效果一致，如果两种类型的配置文件都存在，.babelrc 会覆盖 babel.config.js 的配置。</strong></p>
<p><strong>注意 2：在 package.json 里面写配置还是创建配置文件都没有什么区别，看个人习惯。react 官方脚手架 create-react-app 创建的 react 项目 babel 配置是写在 package.json 里面的，而 vue 官方脚手架@vue&#x2F;cli 创建的 vue 项目，则是通过 babel.config.js 设置。</strong></p>
<h2 id="Plugins-和-Presets"><a href="#Plugins-和-Presets" class="headerlink" title="Plugins 和 Presets"></a>Plugins 和 Presets</h2><p>有了配置文件，接下来就是要通过配置文件告诉 babel 编译哪些内容，然后还要引入对应的编译插件（Plugins），比如上面讲到的箭头函数的转换需要的是<a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/babel-plugin-transform-arrow-functions">@babel&#x2F;plugin-transform-arrow-functions</a>这个插件，我们通过 npm 安装这个包之后在配置里面进行设置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @babel/plugin-transform-arrow-functions -D</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// babel.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="string">&quot;@babel/plugin-transform-arrow-functions&quot;</span>],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>现在我们代码中的箭头函数就会被编译成普通函数，但是有个问题，我们总不能一个个的引入这些插件，来对应转化我们用到的每个新特性，这是非常麻烦的，于是有了一个东西叫做预设（Presets）。</p>
<p>预设其实就是一个预先设定的插件列表，使用一个预设就是将这个预设规定的全部插件安装并使用，比如预设<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@babel/preset-es2015">@babel&#x2F;preset-es2015</a>，这个预设就包含了@babel&#x2F;plugin-transform-arrow-functions，以及其他 es2015 新特性的转换插件，像 for-of，class，模板字符串等。我们只用通过 npm 安装这个预设包，并像下面这样设置，就可以在我们的代码中随意使用这些 es2015 的新特性，编译时 babel 会将这些代码转换成低版本浏览器也能识别兼容的代码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @babel/preset-es2015 -D</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// babel.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-es2015&quot;</span>],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>注意：babel 不光支持新语法特性的转换，react，vue 的语法也是通过 babel 转换的，比如 react 项目可以使用 preset-react。</strong></p>
<h2 id="preset-env"><a href="#preset-env" class="headerlink" title="preset-env"></a>preset-env</h2><p>preset 虽然已经大大方便了我们的使用，但是如果我们还想使用更新一些的语法，比如 es2016 的**（相当于 pow()）,es2017 的 async&#x2F;await 等等，我们就要引入@babel&#x2F;preset-es2016，@babel&#x2F;preset-es2017 之类的，而且随着 js 语法的更新，这些 preset 会越来越多。于是 babel 推出了 babel-env 预设，这是一个智能预设，只要安装这一个 preset，就会根据你设置的目标浏览器，自动将代码中的新特性转换成目标浏览器支持的代码。</p>
<p>还以转化箭头函数举例，npm 安装@babel&#x2F;preset-env 并配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @babel/preset-env -D</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// babel.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;@babel/preset-env&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">targets</span>: &#123;</span><br><span class="line">          <span class="attr">chrome</span>: <span class="string">&quot;58&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>编译后我们会发现箭头函数并未被转换成普通函数，那是因为我们设置目标浏览器支持到 chrome58，chrome58 是原生支持箭头函数的，所以箭头函数就并未被转换，如果我们将目标浏览器设置为支持 ie9,由于 ie9 并不支持箭头，编译后就会发现箭头函数被转换成了普通函数。</p>
<p>目标浏览器版本设置方式详情可参考<a target="_blank" rel="noopener" href="https://github.com/browserslist/browserslist#queries">browserslist</a>,<br>浏览器特性支持可查询<a target="_blank" rel="noopener" href="https://caniuse.com/">caniuse</a>。</p>
<p><strong>注意 1：即使不设置 targes，也会有一个默认值，规则为 &gt; 0.5%, last 2 versions, Firefox ESR, not dead。</strong><br><strong>注意 2：官方推荐使用 preset-env。</strong></p>
<h2 id="plugin-transform-runtime-和-runtime"><a href="#plugin-transform-runtime-和-runtime" class="headerlink" title="plugin-transform-runtime 和 runtime"></a>plugin-transform-runtime 和 runtime</h2><p>当我在用 babel 编译时，有些功能需要一些工具函数来辅助实现，比如 class 的编译。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">People</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// babel编译后</span></span><br><span class="line">(<span class="string">&quot;use strict&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_classCallCheck</span>(<span class="params">instance, Constructor</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(instance <span class="keyword">instanceof</span> <span class="title class_">Constructor</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&quot;Cannot call a class as a function&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">People</span> = <span class="keyword">function</span> <span class="title function_">People</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">_classCallCheck</span>(<span class="variable language_">this</span>, <span class="title class_">People</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>编译后的代码中，_classCallCheck 就是一个辅助功能实现的工具函数。如果多个文件中都用到了 class，每一个文件编译后都生成一个工具函数，最后就会产生大量重复代码，平白增加文件体积。而 plugin-transform-runtime 就是为了解决这个问题，这个插件会将这些工具函数转换成引入的形式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @babel/plugin-transform-runtime -D</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="string">&quot;@babel/plugin-transform-runtime&quot;</span>],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>安装设置完成之后再用 babel 编译结如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _interopRequireDefault = <span class="built_in">require</span>(<span class="string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _classCallCheck2 = <span class="title function_">_interopRequireDefault</span>(</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;@babel/runtime/helpers/classCallCheck&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">People</span> = <span class="keyword">function</span> <span class="title function_">People</span>(<span class="params"></span>) &#123;</span><br><span class="line">  (<span class="number">0</span>, _classCallCheck2[<span class="string">&quot;default&quot;</span>])(<span class="variable language_">this</span>, <span class="title class_">People</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>_classCallCheck2 这个工具函数已经变成从一个 npm 包中引入，不会再产生单独的工具函数代码。但是可以看到工具函数是从@babel&#x2F;runtime 这个包中引入，所以要安装@babel&#x2F;runtime 这个依赖包，在项目打包的时候才不会报错。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @babel/runtime</span><br></pre></td></tr></table></figure>

<p><strong>注意:babel&#x2F;runtime 并不是开发依赖，而是项目生产依赖。编译时使用了 plugin-transform-runtime，你的项目就要依赖于 babel&#x2F;runtime，所以这两个东西是一起使用的。</strong></p>
<h2 id="babel-polyfill"><a href="#babel-polyfill" class="headerlink" title="babel-polyfill"></a>babel-polyfill</h2><p>babel 可以转化一些新的特性，但是对于新的内置函数（Promise,Set,Map），静态方法（Array.from,Object.assign），实例方法（Array.prototype.includes）这些就需要 babel-polyfill 来解决，babel-polyfill 会完整模拟一个 ES2015+环境。</p>
<p>比如你的代码中用到了 Array.from，但是目标浏览器不支持 Array.from，引入 babel-polyfill 就会给 Array 添加一个 from 方法，代码执行的时候使用的 Array.from 其实是 babel-polyfill 模拟出来功能，这样虽然污染了 Array 的静态方法，但是确实实现了兼容。<br>之前的使用方式是 npm 安装@babel&#x2F;polyfill，并在项目入口处引入@babel&#x2F;polyfill 包。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @babel/polyfill</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// entry.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@babel/polyfill&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>但是这种方式已经被废弃不推荐使用，因为@babel&#x2F;polyfill 体积比较大，整体引入既增加项目体积，又污染了过多的变量，所以更推荐使用 preset-env 来按需引入 polyfill。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// babel.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;@babel/preset-env&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">useBuiltIns</span>: <span class="string">&quot;usage&quot;</span>, <span class="comment">// usage-按需引入 entry-入口引入（整体引入） false-不引入polyfill</span></span><br><span class="line">        <span class="attr">corejs</span>: <span class="number">2</span>, <span class="comment">// 2-corejs@2  3-corejs@3</span></span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>corejs 是一个给低版本的浏览器提供接口的库，也是 polyfill 功能实现的核心，此处指定的是引入 corejs 的版本，需要通过 npm 安装指定版本的 corejs 库作为生产依赖。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i core-js@2</span><br></pre></td></tr></table></figure>

<p>之后执行 babel 编译可以看到如下效果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="title class_">Array</span>.<span class="title function_">from</span>([<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//babel编译后</span></span><br><span class="line">(<span class="string">&quot;use strict&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es6.string.iterator&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es6.array.from&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="title class_">Array</span>.<span class="title function_">from</span>([<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>

<p>可以看到在使用 Array.from 之前，提前从 core-js 引入了相应的 polyfill，根据文件名，我们大概猜到它们的功能是什么。</p>
<h2 id="plugin-transform-runtime-和-babel-polyfill-的讨论"><a href="#plugin-transform-runtime-和-babel-polyfill-的讨论" class="headerlink" title="plugin-transform-runtime 和 babel-polyfill 的讨论"></a>plugin-transform-runtime 和 babel-polyfill 的讨论</h2><p>上面说了 plugin-transform-runtime 主要是负责将工具函数转换成引入的方式，减少重复代码，而 babel-polyfill 则是引入相关文件模拟兼容环境。babel-polyfill 有一个问题就是引入文件会污染变量，其实 plugin-transform-runtime 也提供了一种 runtime 的 polyfill。<br>我们将配置文件修改一下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [[<span class="string">&quot;@babel/plugin-transform-runtime&quot;</span>, &#123; <span class="attr">corejs</span>: <span class="number">2</span> &#125;]],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里的 corejs 和 presets 里设置的 corejs 是不同的，这个地方的 corejs 是指定了一个叫 runtime-corejs 库的版本，使用时也需要用 npm 安装对应的包。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @babel/runtime-corejs2</span><br></pre></td></tr></table></figure>

<p>然后执行一下 babel 编译看一下区别。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="title class_">Array</span>.<span class="title function_">from</span>([<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//babel编译后</span></span><br><span class="line">(<span class="string">&quot;use strict&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _interopRequireDefault = <span class="built_in">require</span>(<span class="string">&quot;@babel/runtime-corejs2/helpers/interopRequireDefault&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _from = <span class="title function_">_interopRequireDefault</span>(</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;@babel/runtime-corejs2/core-js/array/from&quot;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = (<span class="number">0</span>, _from[<span class="string">&quot;default&quot;</span>])([<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>

<p>可以看到，此方法和使用 babel-polyfill 的区别是，并没有改变 Array.from,而是创建了一个_from 来模拟 Array.from 的功能，调用 Array.from 会被编译成调用_from，这样做的好处很明显就是不会污染 Array 上的静态方法 from，plugin-transform-runtime 提供的 runtime 形式的 polyfill 都是这种形式。</p>
<p>经过我的测试，除了原型上的方法如 Array.prototype.includes 这种的，其它之前提到的内置函数（Promise,Set,Map），静态方法（Array.from,Object.assign）都可以采用 plugin-transform-runtime 的这种形式。</p>
<p>然后我就想，既然这种形式不会污染变量，那当然能用就用这种了，但是群里问了一下后，大佬们给出了一个看法（感谢大佬 justjavac 和小时哥的说明）。</p>
<blockquote>
<p>runtime 不污染全局变量，但是会导致多个文件出现重复代码。<br>写类库的时候用 runtime，系统项目还是用 polyfill。<br>写库使用 runtime 最安全，如果我们使用了 includes，但是我们的依赖库 B 也定义了这个函数，这时我们全局引入 polyfill 就会出问题：覆盖掉了依赖库 B 的 includes。如果用 runtime 就安全了，会默认创建一个沙盒,这种情况 Promise 尤其明显，很多库会依赖于 bluebird 或者其他的 Promise 实现,一般写库的时候不应该提供任何的 polyfill 方案，而是在使用手册中说明用到了哪些新特性，让使用者自己去 polyfill。</p>
</blockquote>
<p>话说的已经很明白了，该用哪种形式是看项目类型了，不过通常对于一般业务项目来说，还是 plugin-transform-runtime 处理工具函数，babel-polyfill 处理兼容。</p>
<h2 id="最后总结"><a href="#最后总结" class="headerlink" title="最后总结"></a>最后总结</h2><table>
<thead>
<tr>
<th>包名</th>
<th>功能</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@babel&#x2F;core</td>
<td>babel 编译核心包</td>
<td>必装开发依赖</td>
</tr>
<tr>
<td>@babel&#x2F;cli</td>
<td>命令行执行 babel 命令工具</td>
<td>非必装开发依赖，packages.json 的 script 中使用了 babel 命令则需安装</td>
</tr>
<tr>
<td>babel-loader</td>
<td>webpack 中使用 babel 加载文件</td>
<td>非必装开发依赖，webpack 项目中使用</td>
</tr>
<tr>
<td>@babel&#x2F;plugin-*</td>
<td>babel 编译功能实现插件</td>
<td>开发依赖，按照需要的功能安装</td>
</tr>
<tr>
<td>@babel&#x2F;preset-*</td>
<td>功能实现插件预设</td>
<td>开发依赖，按照需要的功能安装，js 语言新特性转换推荐使用 preset-env</td>
</tr>
<tr>
<td>@babel&#x2F;plugin-transform-runtime</td>
<td>复用工具函数</td>
<td>非必装开发依赖，和@babel&#x2F;runtime 同时存在</td>
</tr>
<tr>
<td>@babel&#x2F;runtime</td>
<td>工具函数库</td>
<td>非必装生产依赖，和@babel&#x2F;plugin-transform-runtime 同时存在</td>
</tr>
<tr>
<td>@babel&#x2F;polyfill</td>
<td>低版本浏览器兼容库</td>
<td>非必装生产依赖，已不推荐使用，推荐通过 preset-env 的 useBuiltIns 属性按需引入</td>
</tr>
<tr>
<td>core-js@*</td>
<td>低版本浏览器兼容库</td>
<td>非必装生产依赖，通过 preset-env 引入 polyfill 需安装此包，并通过 corejs 指定版本</td>
</tr>
<tr>
<td>@babel&#x2F;runtime-corejs*</td>
<td>不污染变量的低版本浏览器兼容库</td>
<td>非必装生产依赖，plugin-transform-runtime 设置开启后，可以不污染变量的引入 polyfill</td>
</tr>
</tbody></table>
<p>babel 使用的相关内容基本就这些了，至于 babel 编译内部实现原理感兴趣的可以深入研究，也可以自己写一些 babel 的 plugins 和 preset 发布到 npm 上供大家使用，希望看完此文能对大家理解和使用 babel 有一点帮助。</p>
<p>能力一般，水平有限，欢迎大家多多指正讨论。</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/haojen"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Haojen 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>